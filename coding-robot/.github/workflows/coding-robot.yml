name: Coding Robot

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    # ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶: /code ã¾ãŸã¯ ğŸ¤– ã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆãƒ»Issueãƒ»Pull Request
    if: |
      (github.event_name == 'issue_comment' && (contains(github.event.comment.body, '/code') || contains(github.event.comment.body, 'ğŸ¤–'))) ||
      (github.event_name == 'pull_request_review_comment' && (contains(github.event.comment.body, '/code') || contains(github.event.comment.body, 'ğŸ¤–'))) ||
      (github.event_name == 'pull_request_review' && (contains(github.event.review.body, '/code') || contains(github.event.review.body, 'ğŸ¤–'))) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '/code') || contains(github.event.issue.body, 'ğŸ¤–') || contains(github.event.issue.title, '/code') || contains(github.event.issue.title, 'ğŸ¤–')))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      packages: write
      actions: read

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: å³åº§ã« ğŸ‘€ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      - name: Add eyes reaction to comment
        run: |
          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆIDã¨URLã‚’è¨­å®š
          if [ "${{ github.event_name }}" = "issue_comment" ] || [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            COMMENT_ID="${{ github.event.comment.id }}"
            REACTION_URL="https://api.github.com/repos/${{ github.repository }}/issues/comments/$COMMENT_ID/reactions"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            COMMENT_ID="${{ github.event.review.id }}"
            REACTION_URL="https://api.github.com/repos/${{ github.repository }}/pulls/comments/$COMMENT_ID/reactions"
          elif [ "${{ github.event_name }}" = "issues" ]; then
            COMMENT_ID="${{ github.event.issue.number }}"
            REACTION_URL="https://api.github.com/repos/${{ github.repository }}/issues/$COMMENT_ID/reactions"
          fi

          if [ -n "$COMMENT_ID" ]; then
            echo "Adding ğŸ‘€ reaction (event: ${{ github.event_name }}, id: $COMMENT_ID)"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "$REACTION_URL" \
              -d '{"content":"eyes"}'
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—2: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ã‚¹ãƒ†ãƒƒãƒ—3: GHCR ã«ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ã‚¹ãƒ†ãƒƒãƒ—4: devcontainer ã§å®Ÿè¡Œ
      - name: Run Claude Bot in devcontainer
        id: run_claude
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer/devcontainer.json
          imageName: ghcr.io/${{ github.repository }}/devcontainer-ci
          push: always
          cacheFrom: |
            ghcr.io/${{ github.repository }}/devcontainer-ci:latest
          env: |
            CLAUDE_CODE_OAUTH_TOKEN=${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
            GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
            FIREBASE_TOKEN=${{ secrets.FIREBASE_TOKEN }}
            GITHUB_REPOSITORY=${{ github.repository }}
            GITHUB_RUN_ID=${{ github.run_id }}
            ISSUE_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
            EVENT_TYPE=${{ github.event_name }}
            COMMENT_ID=${{ github.event.comment.id }}
            DEVCONTAINER_CONFIG_PATH=.devcontainer/devcontainer.json
            CLAUDE_TIMEOUT=5400
          runCmd: |
            # Run Claude Bot
            ./.github/coding-robot/run-action.sh

      # ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†: ğŸ‘€ ã‚’å‰Šé™¤ã—ã¦ ğŸ˜Ÿ ã‚’è¿½åŠ 
      - name: Handle error - Remove eyes and add confused reaction
        if: failure()
        run: |
          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆIDã¨URLã‚’è¨­å®š
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_ID="${{ github.event.comment.id }}"
            REACTIONS_URL="https://api.github.com/repos/${{ github.repository }}/issues/comments/$COMMENT_ID/reactions"
            DELETE_URL_PREFIX="https://api.github.com/repos/${{ github.repository }}/issues/comments/$COMMENT_ID/reactions"
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            COMMENT_ID="${{ github.event.comment.id }}"
            REACTIONS_URL="https://api.github.com/repos/${{ github.repository }}/pulls/comments/$COMMENT_ID/reactions"
            DELETE_URL_PREFIX="https://api.github.com/repos/${{ github.repository }}/pulls/comments/$COMMENT_ID/reactions"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            COMMENT_ID="${{ github.event.review.id }}"
            REACTIONS_URL="https://api.github.com/repos/${{ github.repository }}/pulls/comments/$COMMENT_ID/reactions"
            DELETE_URL_PREFIX="https://api.github.com/repos/${{ github.repository }}/pulls/comments/$COMMENT_ID/reactions"
          elif [ "${{ github.event_name }}" = "issues" ]; then
            COMMENT_ID="${{ github.event.issue.number }}"
            REACTIONS_URL="https://api.github.com/repos/${{ github.repository }}/issues/$COMMENT_ID/reactions"
            DELETE_URL_PREFIX="https://api.github.com/repos/${{ github.repository }}/issues/$COMMENT_ID/reactions"
          fi

          if [ -n "$COMMENT_ID" ]; then
            echo "Handling error (event: ${{ github.event_name }}, id: $COMMENT_ID)"

            # æ—¢å­˜ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦ ğŸ‘€ ã‚’è¦‹ã¤ã‘ã‚‹
            REACTIONS=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "$REACTIONS_URL")

            echo "Reactions response:"
            echo "$REACTIONS" | jq .

            # ğŸ‘€ (eyes) ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®IDã‚’æŠ½å‡ºã—ã¦å‰Šé™¤
            echo "$REACTIONS" | jq -r '.[] | select(.content == "eyes") | .id' | while read REACTION_ID; do
              if [ -n "$REACTION_ID" ]; then
                echo "Removing eyes reaction $REACTION_ID from $DELETE_URL_PREFIX/$REACTION_ID"
                curl -X DELETE \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "$DELETE_URL_PREFIX/$REACTION_ID"
              fi
            done

            # ğŸ˜Ÿ (confused) ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            echo "Adding ğŸ˜Ÿ reaction"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "$REACTIONS_URL" \
              -d '{"content":"confused"}'
          fi
